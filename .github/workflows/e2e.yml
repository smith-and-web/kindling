name: E2E Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  # Allow manual trigger
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0
  RUST_BACKTRACE: short

jobs:
  e2e:
    name: E2E Tests (Linux)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: "npm"

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            src-tauri/target/
          key: ${{ runner.os }}-e2e-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-e2e-cargo-

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf \
            webkit2gtk-driver \
            xvfb

      - name: Install tauri-driver
        run: cargo install tauri-driver || true

      - name: Install npm dependencies
        run: npm ci

      - name: Install e2e dependencies
        working-directory: e2e
        run: npm ci

      - name: Build Tauri app (release)
        run: npm run tauri build
        env:
          TAURI_SIGNING_PRIVATE_KEY: ""
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ""

      - name: Setup test data for reimport tests
        run: |
          # Ensure test files are in place
          ls -la test-data/

      - name: Run E2E tests
        working-directory: e2e
        run: |
          # Start Xvfb for headless display
          export DISPLAY=:99
          Xvfb :99 -screen 0 1920x1080x24 &
          sleep 2

          # Run tests
          npm run test:ci
        env:
          # Point to the built binary
          TAURI_BINARY: ../src-tauri/target/release/kindling

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-results
          path: |
            e2e/logs/
            e2e/screenshots/
          retention-days: 7

      - name: Upload test screenshots on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-failure-screenshots
          path: e2e/screenshots/
          retention-days: 14
