name: E2E Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  # Allow manual trigger
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 1
  RUST_BACKTRACE: short

jobs:
  e2e:
    name: E2E Tests (Linux)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: "npm"

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-registry-

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: src-tauri/target/
          key: ${{ runner.os }}-e2e-cargo-build-${{ hashFiles('**/Cargo.lock') }}-${{ hashFiles('src-tauri/src/**') }}
          restore-keys: |
            ${{ runner.os }}-e2e-cargo-build-${{ hashFiles('**/Cargo.lock') }}-
            ${{ runner.os }}-e2e-cargo-build-

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf \
            webkit2gtk-driver \
            xvfb

      - name: Install tauri-driver
        run: |
          if ! command -v tauri-driver &> /dev/null; then
            cargo install tauri-driver
          else
            echo "tauri-driver already installed"
          fi

      - name: Install npm dependencies
        run: npm ci

      - name: Install e2e dependencies
        working-directory: e2e
        run: npm ci

      - name: Build Tauri app (release)
        run: npm run tauri build
        env:
          TAURI_SIGNING_PRIVATE_KEY: ""
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ""

      - name: Verify build output
        run: |
          ls -la src-tauri/target/release/kindling || echo "Binary not found!"
          ls -la test-data/

      - name: Run E2E tests
        working-directory: e2e
        run: |
          # Start Xvfb for headless display
          export DISPLAY=:99
          Xvfb :99 -screen 0 1920x1080x24 &
          sleep 2

          # Verify tauri-driver is available
          which tauri-driver
          tauri-driver --version || echo "tauri-driver version check failed"

          # Run tests
          npm run test:ci
        env:
          DISPLAY: ":99"

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-results
          path: |
            e2e/logs/
            e2e/screenshots/
          retention-days: 7
          if-no-files-found: ignore

      - name: Upload test screenshots on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-failure-screenshots
          path: e2e/screenshots/
          retention-days: 14
          if-no-files-found: ignore
